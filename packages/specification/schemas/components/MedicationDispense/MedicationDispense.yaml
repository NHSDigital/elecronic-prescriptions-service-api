type: object
properties:
  resourceType:
    type: string
    description: FHIR resource type.
    enum: [MedicationDispense]
  contained:
    type: array
    items:
      oneOf:
      - $ref: '../PractitionerRole/CreatePractitionerRole.yaml'
      - $ref: '../MedicationRequest/MedicationRequest.yaml'
  extension:
    type: array
    description: A FHIR extension array.
    items:
      $ref: 'extensions/EPSTaskBusinessStatus.yaml'
  identifier:
    type: array
    description: The unique ID for each line item on a prescription.
    items:
      type: object
      properties:
        system:
          type: string
          description: codesystem URL for the line item ID.
          enum: [https://fhir.nhs.uk/Id/prescription-dispense-item-number]
        value:
          type: string
          description: The unique ID for a given line item.
          example: fd833d33-f128-4fa2-a807-1fc8a7db2658
  status: 
    type: string
    description: |
      The status of the individual medication item.
      This will normally indicate whether the medication has been picked up or not.
    enum: [preparation, in-progress, cancelled, on-hold, completed, entered-in-error, stopped, declined, unknown]
  statusReasonCodeableConcept:
    type: object
    description: The reason for the status of the medication dispense.
    properties:
      coding:
        type: array
        items:
          type: object
          properties:
            system:
              type: string
              description: Status reason codesystem URL.
              enum: [https://fhir.nhs.uk/CodeSystem/medicationdispense-status-reason]
            code:
              type: string
              description: Status reason code for the medication dispense, as defined in the DM+D.
              example: "0003"
            display:
              type: string
              description: Human readable representation of the code.
              example: Owings note issued to patient
  medicationCodeableConcept:
    type: object
    description: |
      The medication that is being dispensed. 
      This must be defined using VMP or AMP concepts from the DM+D.
    properties:
      coding:
        type: array
        items:
          type: object
          properties:
            system:
              type: string
              description: SNOMED codesystem URL.
              enum: [http://snomed.info/sct]
            code:
              type: string
              description: SNOMED code for the medication, as defined in the DM+D.
              example: "39732311000001104"
            display:
              type: string
              description: Human readable name for the medication.
              example: Amoxicillin 250mg capsules
  subject:
    type: object
    description: A reference to the patient via a traced NHS Number.
    properties:
      type: 
        type: string
        description: A coded type for the identifier that can be used to determine which identifier to use for a specific purpose.
        example: Patient
      identifier: 
        $ref: './Identifier.yaml'
      display:
        type: string
        example: Ms Marisa Stacey Twitchett
  performer:
    type: array
    items:
      type: object
      properties:
        actor:
          type: object
          properties:
            reference:
              type: string
              example: "#performer"
  authorizingPrescription:
    type: array
    items:
      type: object
      properties:
        reference: 
          type: string
          description: Literal reference, relative, internal or absolute URL.
          example: '#m1'
  type:
    type: object
    properties:
      coding:
        type: array
        items:
          type: object
          properties:
              system:
                type: string
                enum: [https://fhir.nhs.uk/CodeSystem/medicationdispense-type]
              code:
                type: string
                example: '0001'
              display:
                type: string
                example: Item fully dispensed
  quantity:
    type: object
    description: The amount of medication that has been dispensed. Includes unit of measure.
    properties:
      extension:
        type: array
        items:
          type: object
          properties:
            url:
              type: string
              enum: [https://fhir.nhs.uk/StructureDefinition/Extension-DM-RunningTotal]
            valueQuantity:
              type: object
              properties:
                value:
                  type: integer
                  description: The value of the measured amount. The value includes an implicit precision in the presentation of the value.
                  example: 20
                unit: 
                  type: string
                  description: A human-readable form of the unit.
                  example: tablet
                system:
                  type: string
                  description: The identification of the system that provides the coded form of the unit.
                  enum: [http://snomed.info/sct]
                code:
                  type: string
                  description: A computer processable form of the unit in some unit representation system.
                  example: '732936001'
      value:
        type: integer
        description: The value of the measured amount. The value includes an implicit precision in the presentation of the value.
        example: 20
      unit: 
        type: string
        description: A human-readable form of the unit.
        example: tablet
      system:
        type: string
        description: The identification of the system that provides the coded form of the unit.
        enum: [http://snomed.info/sct]
      code:
        type: string
        description: A computer processable form of the unit in some unit representation system.
        example: '732936001'
  daysSupply:
    type: object
    properties:
      value:
        type: integer
        description: The value of the measured amount. The value includes an implicit precision in the presentation of the value.
        example: 10
      unit: 
        type: string
        description: A human-readable form of the unit.
        example: Day
      system:
        type: string
        description: The identification of the system that provides the coded form of the unit.
        example: http://unitsofmeasure.org
      code:
        type: string
        description: A computer processable form of the unit in some unit representation system.
        example: d
  whenPrepared: 
    type: string
    format: date-time
    example: '2023-04-11T10:11:12+00:00'
  whenHandedOver: 
    type: string
    format: date-time
    example: '2023-04-11T10:11:12+00:00'
  dosageInstruction:
    type: array
    description: |
      The dosage instructions for a prescription. 
      These must be expressed as both structured dose and text.
    items:
      type: object
      properties:
        text:
          type: string
          description: The dosage instructions expressed as text.
          example: 4 times a day - Oral
        timing:
          type: object
          description: A structured expression of dose frequency.
          properties:
            repeat:
              type: object
              description: The frequency and period over which the medication should be consumed.
              properties:
                frequency:
                  type: integer
                  description: |
                    The frequency at which the medication should be consumed within a given period.
                    E.g. "4" for 4 times over a given period. 
                  format: int32
                  example: 4
                period:
                  type: integer
                  description: |
                      The period over which the frequency applies.
                      e.g. "1" for 1 day.
                  format: int32
                  example: 1
                periodUnit:
                  type: string
                  description: The fundamental unit of the period, defined in UCUM.
                  example: d
        route:
          type: object
          description: A structured expression of how the medication should be consumed.
          properties:
            coding:
              type: array
              items:
                type: object
                properties:
                  system:
                    type: string
                    description: SNOMED codesystem URL.
                    enum: [http://snomed.info/sct]
                  code:
                    type: integer
                    description: Valid SNOMED code identifying how the medication should be consumed.
                    example: "26643006"
                  display:
                    type: string
                    example: Oral
