type: object
required: []
properties:
  resourceType:
    type: string
    description: FHIR resource type
    enum: [MedicationDispense]
  contained:
    type: array
    items:
      oneOf:
      - $ref: '../PractitionerRole/CreatePractitionerRole.yaml'
      - $ref: '../MedicationRequest/MedicationRequest.yaml'
      - $ref: '../Practitioner/CreatePractitioner.yaml'

  extension:
    type: array
    description: a FHIR extension array.
    items:
      oneOf:
      - $ref: 'extension/PrescriptionStatus'
      - $ref: 'extensions/DispensingInformation.yaml'
      - $ref: 'extensions/MedicationRepeatInformation.yaml'
      - $ref: './identifier.yaml'

  identifier:
    type: array
    description: The unique ID for each line item on a prescription.
    items:
      type: object
      properties:
        system:
          type: string
          description: codesystem URL for the line item ID.
          enum: ["https://fhir.nhs.uk/Id/prescription-order-item-number"]
        value:
          type: string
          description: the unique ID for a given line item.
          example: 4509B70D-D8B8-EA03-1105-64557CB54A29

  status: 
    type: string
    description: The status of the individual medication item, this will normally indicate whether the medication has been picked up or not.
    enum: ["preparation", "in-progress", "cancelled", "on-hold", "completed", "entered-in-error","stopped", "declined", "unknown"]
  
  statusReason: 
    type: object
    properties: 
      statusReasonCode:
        type: object
        properties:
          coding: 
            type: array
            items:
              allOf: 
                  type: object
                  properties:
                    system:
                      type: string
                      description: CodeSystem URL for the short-form prescription ID.
                      enum: ["https://fhir.nhs.uk/CodeSystem/medicationdispense-status-reason"]
                    version:
                      type: string
                      description: The version of the code system which was used when choosing this code.
                    code:
                      type: string
                      description: Code for non dispensing reason.
                    display:
                      type: string
                      description: Human readable representation of code.
                    userSelected:
                      type: boolean
                      description: If this coding was chosen directly by the user.
  
  category:
    type: object
    properties:
      system:
        type: string
        description: CodeSystem URL for the short-form prescription ID.
        enum: ["https://fhir.nhs.uk/CodeSystem/medicationdispense-status-reason"]
      version:
        type: string
        description: The version of the code system which was used when choosing this code.
      code:
        type: string
        description: Code for non dispensing reason.
      display:
        type: string
        description: Human readable representation of code.
      userSelected:
        type: boolean
        description: If this coding was chosen directly by the user.
  
  medication:
    type: object
    properties:
      medicationCodeableConcept:
        type: object
        properties: 
          system:
            type: string
            description: TODO not sure what this should be nothing on IG
          code: 
            type: string
            description: TODO not sure what this should be nothing on IG
  
  subject:
    type: object
    description: A reference to the patient via a traced NHS Number.
    properties:
      reference:
        type: string
        description: Literal reference, Relative, internal or absolute URL
      type: 
        type: string
        description: A coded type for the identifier that can be used to determine which identifier to use for a specific purpose.
      identifier: - $ref: './identifier.yaml'  
  
  context:
    type: object
    description: The encounter or episode of care that establishes the context for this event. 
    properties: 
      reference:
        type: string
        description:  A reference to a location at which the other resource is found.
      type: 
        string: string
        description: Type the reference refers to.
        example: Patient

      identifier: - $ref: './identifier.yaml'  
      display:
        type: string
        description: Plain text narrative that identifies the resource in addition to the resource reference.

  supportingInformation:
    type: object
    properties:
      reference:
        type: string
        description: Literal reference, Relative, internal or absolute URL
      type: 
        string: string
        description: Type the reference refers to.
        example: Patient
      identifier: - $ref: './identifier.yaml'  

  location:
    type: object
    description: The principal physical location where the dispense was performed
    properties: 
      reference: 
        type: string
        description: Literal reference, Relative, internal or absolute URL
      type: 
        type: string
        description: The expected type of the target of the reference.
      identifier: - $ref: './identifier.yaml'  
      display:
        type: string
        description: Plain text narrative that identifies the resource in addition to the resource reference.

  authorizingPrescription:
    type: array
    items:
      oneOf:
        type: object
        properties:
          reference: 
            type: string
            description: Literal reference, Relative, internal or absolute URL
            example: '#m3'
          identifier: - $ref: './identifier.yaml' 
          display:
            type: string
            description: Plain text narrative that identifies the resource in addition to the resource reference.  
  
  type:
    type: object
    properties:
      coding:
      type: array
      items:
        oneof:
        type: object
        properties:
            system:
              type: string
              example: https://fhir.nhs.uk/CodeSystem/medicationdispense-type
            code:
              type: string
              example: '0004'
            display:
              type: string
              example: Item not dispensed owing
      text:
        type: string
        description: Version of the system

  quantity:
    type: object
    description: he amount of medication that has been dispensed. Includes unit of measure.
    properties:
      value:
        type: decimal
        description: The value of the measured amount. The value includes an implicit precision in the presentation of the value.
      unit: 
        type: string
        description: A human-readable form of the unit.
      system:
        type: string
        description: The identification of the system that provides the coded form of the unit.
      code:
        type: object
        properties:
          value: 
          type: string
          description: A computer processable form of the unit in some unit representation system.

  daysSupply:
    type: object
    properties:
      value:
        type: decimal
        description: The value of the measured amount. The value includes an implicit precision in the presentation of the value.
      unit: 
        type: string
        description: A human-readable form of the unit.
      system:
        type: string
        description: The identification of the system that provides the coded form of the unit.
      code:
        type: object
        properties:
          value: 
          type: string
          description: A computer processable form of the unit in some unit representation system.

  whenPrepared: 
    type: string
    example: "2004-09-16T16:30:00+00:00"
  whenHandOver: 
    type: string
    example: "2004-09-16T16:30:00+00:00"
  
  destination:
    type: object
    properties:
      reference: 
        type: string
        description: Literal reference, Relative, internal or absolute URL
      type:
        type: string
        description: The expected type of the target of the reference. If both Reference.type and Reference.reference are populated and Reference.reference is a FHIR URL, both SHALL be consistent.
      identifier: - $ref: './identifier.yaml'
      display:
        type: string
        description: Plain text narrative that identifies the resource in addition to the resource reference.
  
  receiver:
    type: object
    properties:
      reference: 
        type: string
        description: Literal reference, Relative, internal or absolute URL
      type:
        type: string
        description: The expected type of the target of the reference. If both Reference.type and Reference.reference are populated and Reference.reference is a FHIR URL, both SHALL be consistent.
      identifier: - $ref: './identifier.yaml'
      display:
        type: string
        description: Plain text narrative that identifies the resource in addition to the resource reference.
  note:
    type: object
    properties:
      authorString:
        type: string
        description:  Who collected the medication
      authorReference:
        type: object
        properties:
          reference: 
            type: string
            description: Literal reference, Relative, internal or absolute URL
          type:
            type: string
            description: The expected type of the target of the reference. If both Reference.type and Reference.reference are populated and Reference.reference is a FHIR URL, both SHALL be consistent.
          identifier: - $ref: './identifier.yaml'
          display:
            type: string
            description: Plain text narrative that identifies the resource in addition to the resource reference.
      time:
        type: string
        description: When the annotation was made
        example: "2004-09-16T16:30:00+00:00"
      text:
        type: string
        description: The annotation - text content (as markdown)
  dosageInstruction:
    type: array
    description: |
      The dosage instructions for a prescription. 
      These must be expressed as both structured dose and text.
    items:
      type: object
      properties:
        text:
          type: string
          description: The dosage instructions expressed as text.
          example: 4 times a day - Oral
        timing:
          type: object
          description: A structured expression of dose frequency.
          properties:
            repeat:
              type: object
              description: The frequency and period over which the medication should be consumed.
              properties:
                frequency:
                  type: integer
                  description: |
                    The frequency at which the medication should be consumed within a given period.
                    E.g. "4" for 4 times over a given period. 
                  format: int32
                  example: 4
                period:
                  type: integer
                  description: |
                      The period over which the frequency applies.
                      e.g. "1" for 1 day.
                  format: int32
                  example: 1
                periodUnit:
                  type: string
                  description: The fundamental unit of the period, defined in UCUM.
                  example: d
        route:
          type: object
          description: A structured expression of how the medication should be consumed.
          properties:
            coding:
              type: array
              items:
                type: object
                properties:
                  system:
                    type: string
                    description: SNOMED codesystem URL.
                    enum: [http://snomed.info/sct]
                  code:
                    type: integer
                    description: Valid SNOMED code identifying how the medication should be consumed.
                    example: "26643006"
                  display:
                    type: string
                    example: Oral
  
  substitution:
    type: object
    description: This is a boolean value that should always default to false because EPS does not support substitutions.
    properties:
      allowedBoolean:
        type: boolean
        enum: [false]




        
