steps:
  - bash: |
      echo "##[debug] Running post dev deploy"
    displayName: run post dev deploy
  - template: ./run_tests.yml
  # call create release notes
  - bash: |
      export NOTIFY_GITHUB_REPOSITORY=$(NOTIFY_GITHUB_REPOSITORY)
      export BRANCH_NAME=$(Build.SourceBranchName)
      if [ "${BRANCH_NAME}" = "merge" ]; then
        export BRANCH_NAME=$(echo "$(System.PullRequest.SourceBranch)" | awk -F/ '{print $NF}')
      fi

      if [[ -z ${NOTIFY_GITHUB_REPOSITORY} ]]; then
         export NOTIFY_GITHUB_REPOSITORY=$(Build.Repository.Name)
      fi
      cat <<EOF > payload.json
      {
        "ref": "${BRANCH_NAME}"
      }
      EOF
      echo "##[debug] Hitting https://api.github.com/repos/${NOTIFY_GITHUB_REPOSITORY}/actions/workflows/create_int_release_notes.yml/dispatches"
      cat payload.json
      curl --fail -q -X POST "https://api.github.com/repos/${NOTIFY_GITHUB_REPOSITORY}/actions/workflows/create_int_release_notes.yml/dispatches" -d "@./payload.json" --user $(GITHUB_USER):$(GITHUB_ACCESS_TOKEN)
      echo "##[debug] Hitting https://api.github.com/repos/${NOTIFY_GITHUB_REPOSITORY}/actions/workflows/create_prod_release_notes.yml/dispatches"
      curl --fail -q -X POST "https://api.github.com/repos/${NOTIFY_GITHUB_REPOSITORY}/actions/workflows/create_prod_release_notes.yml/dispatches" -d "@./payload.json" --user $(GITHUB_USER):$(GITHUB_ACCESS_TOKEN)
    displayName: Create release notes post dev
    # Run the regression tests
  - bash: |
      export REGRESSION_TESTS_GITHUB_REPOSITORY=$(REGRESSION_TESTS_GITHUB_REPOSITORY)
      if [[ -z ${REGRESSION_TESTS_GITHUB_REPOSITORY} ]]; then
         export REGRESSION_TESTS_GITHUB_REPOSITORY=$(Build.Repository.Name)
      fi
      cat <<EOF > payload.json
      {
          "ref": "main",
          "inputs": {
              "tags": "@regression",
              "environment": "DEV"
          }
      }      EOF
      echo "##[debug] Hitting https://api.github.com/repos/${REGRESSION_TESTS_GITHUB_REPOSITORY}/actions/workflows/regression_tests.yml/dispatches"
      cat payload.json
      curl --fail -q -X POST "https://api.github.com/repos/${REGRESSION_TESTS_GITHUB_REPOSITORY}/actions/workflows/regression_tests.yml/dispatches" -d "@./payload.json" --user $(GITHUB_USER):$(GITHUB_ACCESS_TOKEN)
    displayName: Trigger regression tests

