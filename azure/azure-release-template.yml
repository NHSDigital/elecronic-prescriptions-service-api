parameters:
  - name: service_name
    type: string
  - name: short_service_name
    type: string
  - name: service_base_path
    type: string
  - name: product_display_name
    type: string
  - name: product_description
    type: string
  - name: service_base_path_pr
    type: string
  - name: spec_file
    type: string
  - name: apigee_deployments
    type: object
  - name: enable_monitoring
    type: boolean

extends:
  template: azure/common/apigee-deployment.yml@common
  parameters:
    service_name: ${{ parameters.service_name }}
    short_service_name: ${{ parameters.short_service_name }}
    service_base_path: ${{ parameters.service_base_path }}
    product_display_name: ${{ parameters.product_display_name }}
    product_description: ${{ parameters.product_description }}
    spec_file: ${{ parameters.spec_file }}
    enable_monitoring: ${{ parameters.enable_monitoring }}
    apigee_deployments: ${{ parameters.apigee_deployments }}
    post_deploy:
      - bash: |
          if [[ -d "$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/pact" ]]; then
            echo "##vso[task.setvariable variable=run_smoke_tests]true"
          else
            echo "##vso[task.setvariable variable=run_smoke_tests]false"
          fi
        displayName: Check for smoke tests
      - task: DockerInstaller@0
        displayName: Install docker
        inputs:
          dockerVersion: 17.09.0-ce
          releaseType: stable
        condition: and(succeeded(), eq(variables['run_smoke_tests'], 'true'))
      - task: ShellScript@2
        displayName: Run smoke tests
        condition: and(succeeded(), eq(variables['run_smoke_tests'], 'true'))
        inputs:
          scriptPath: ./scripts/smoke_test.sh
